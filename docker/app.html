<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrendRadar - ÁÉ≠ÁÇπÊñ∞ÈóªËÅöÂêà</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root { --bg-primary: #0f0f23; --bg-secondary: #1a1a2e; --bg-card: #16213e; --text-primary: #e4e4e7; --text-secondary: #a1a1aa; --accent: #7c3aed; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.5; min-height: 100vh; }
        .header { background: var(--bg-secondary); padding: 12px 24px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .header-content { max-width: 1800px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, #7c3aed, #3b82f6); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .logo-text { font-size: 18px; font-weight: 700; background: linear-gradient(135deg, #7c3aed, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo-version { font-size: 11px; color: var(--text-secondary); }
        .main-tabs { display: flex; gap: 4px; }
        .main-tab { padding: 8px 18px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; background: transparent; color: var(--text-secondary); border: none; }
        .main-tab:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
        .main-tab.active { background: var(--accent); color: white; }
        .sub-header { background: var(--bg-secondary); padding: 8px 24px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .sub-tabs { max-width: 1800px; margin: 0 auto; display: flex; gap: 6px; flex-wrap: wrap; }
        .sub-tab { padding: 6px 14px; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.2s; background: rgba(255,255,255,0.05); color: var(--text-secondary); border: none; }
        .sub-tab:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
        .sub-tab.active { background: rgba(124,58,237,0.3); color: white; }
        .main { padding: 20px; max-width: 1800px; margin: 0 auto; }
        .update-info { text-align: center; padding: 12px; color: var(--text-secondary); font-size: 12px; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; }
        .card-grid.single-row .news-card { height: calc(100vh - 220px); min-height: 420px; }
        .news-card { background: var(--bg-card); border-radius: 14px; overflow: hidden; display: flex; flex-direction: column; height: 420px; transition: transform 0.2s, box-shadow 0.2s; }
        .news-card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .card-header { padding: 14px; display: flex; justify-content: space-between; align-items: center; }
        .card-title-wrap { display: flex; align-items: center; gap: 10px; }
        .card-icon { width: 36px; height: 36px; border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; }
        .card-title { font-size: 14px; font-weight: 600; }
        .card-subtitle { font-size: 11px; color: var(--text-secondary); margin-top: 2px; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .card-count { font-size: 11px; padding: 3px 8px; border-radius: 10px; background: rgba(255,255,255,0.1); }
        .news-list { flex: 1; overflow-y: auto; padding: 0 12px 12px; }
        .news-list::-webkit-scrollbar { width: 5px; }
        .news-list::-webkit-scrollbar-track { background: transparent; }
        .news-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
        .news-item { display: flex; gap: 8px; padding: 7px 6px; border-radius: 6px; transition: background 0.2s; }
        .news-item:hover { background: rgba(255,255,255,0.05); }
        .news-rank { min-width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; border-radius: 5px; background: rgba(255,255,255,0.1); flex-shrink: 0; }
        .news-rank.top-1 { background: #fbbf24; color: #1a1a1a; }
        .news-rank.top-2 { background: #94a3b8; color: #1a1a1a; }
        .news-rank.top-3 { background: #cd7f32; color: #1a1a1a; }
        .news-new { display: inline; padding: 1px 4px; background: #ef4444; color: white; font-size: 8px; font-weight: 600; border-radius: 2px; margin-left: 4px; vertical-align: middle; }
        .news-text { flex: 1; min-width: 0; }
        .news-title-link { font-size: 13px; color: var(--text-primary); text-decoration: none; line-height: 1.35; }
        .news-title-link:hover { text-decoration: underline; }
        .news-title-link:visited { color: var(--text-secondary); }
        .news-source { cursor: pointer; transition: color 0.2s; }
        .news-source:hover { color: var(--accent); }
        .news-meta { font-size: 10px; color: var(--text-secondary); margin-top: 3px; }
        .news-source { padding: 1px 5px; background: rgba(255,255,255,0.08); border-radius: 3px; }
        .theme-purple .card-header { background: linear-gradient(135deg, rgba(124,58,237,0.25), rgba(124,58,237,0.08)); }
        .theme-purple .card-icon { background: linear-gradient(135deg, #7c3aed, #9333ea); }
        .theme-blue .card-header { background: linear-gradient(135deg, rgba(59,130,246,0.25), rgba(59,130,246,0.08)); }
        .theme-blue .card-icon { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .theme-green .card-header { background: linear-gradient(135deg, rgba(16,185,129,0.25), rgba(16,185,129,0.08)); }
        .theme-green .card-icon { background: linear-gradient(135deg, #10b981, #059669); }
        .theme-red .card-header { background: linear-gradient(135deg, rgba(239,68,68,0.25), rgba(239,68,68,0.08)); }
        .theme-red .card-icon { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .theme-orange .card-header { background: linear-gradient(135deg, rgba(249,115,22,0.25), rgba(249,115,22,0.08)); }
        .theme-orange .card-icon { background: linear-gradient(135deg, #f97316, #ea580c); }
        .theme-teal .card-header { background: linear-gradient(135deg, rgba(20,184,166,0.25), rgba(20,184,166,0.08)); }
        .theme-teal .card-icon { background: linear-gradient(135deg, #14b8a6, #0d9488); }
        .theme-pink .card-header { background: linear-gradient(135deg, rgba(236,72,153,0.25), rgba(236,72,153,0.08)); }
        .theme-pink .card-icon { background: linear-gradient(135deg, #ec4899, #db2777); }
        .theme-indigo .card-header { background: linear-gradient(135deg, rgba(99,102,241,0.25), rgba(99,102,241,0.08)); }
        .theme-indigo .card-icon { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .topics-nav-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
        .topic-nav-card { background: var(--bg-card); border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s; }
        .topic-nav-card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.2); background: rgba(124,58,237,0.15); }
        .topic-nav-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .topic-nav-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .topic-nav-title { font-size: 15px; font-weight: 600; }
        .topic-nav-keywords { font-size: 11px; color: var(--text-secondary); }
        .topic-nav-stats { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        .topic-nav-btn { color: var(--accent); }
        .report-frame { width: 100%; height: calc(100vh - 160px); border: none; border-radius: 12px; background: white; }
        /* ËÆæÁΩÆÈ°µÈù¢Ê†∑Âºè */
        .settings-container { max-width: 1200px; margin: 0 auto; }
        .settings-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .settings-tab { padding: 10px 20px; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s; background: rgba(255,255,255,0.05); color: var(--text-secondary); border: none; }
        .settings-tab:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
        .settings-tab.active { background: var(--accent); color: white; }
        .settings-panel { display: none; }
        .settings-panel.active { display: block; }
        .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .settings-header h3 { margin: 0; font-size: 18px; color: var(--text-primary); }
        .settings-actions { display: flex; gap: 8px; }
        .btn-primary { padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; border: none; background: var(--accent); color: white; transition: all 0.2s; }
        .btn-primary:hover { background: #7c3aed; }
        .btn-secondary { padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: var(--text-secondary); transition: all 0.2s; }
        .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
        .settings-help { background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; font-size: 13px; color: var(--text-secondary); }
        .settings-help p { margin: 0 0 8px 0; }
        .settings-help ul { margin: 0; padding-left: 20px; }
        .settings-help li { margin: 4px 0; }
        .settings-help code { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #a78bfa; }
        .settings-editor { width: 100%; height: calc(100vh - 380px); min-height: 400px; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 16px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 13px; line-height: 1.6; color: var(--text-primary); resize: vertical; }
        .settings-editor:focus { outline: none; border-color: var(--accent); }
        .platforms-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 8px; }
        .platform-item { display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; cursor: grab; transition: all 0.2s; }
        .platform-item:hover { border-color: rgba(255,255,255,0.2); }
        .platform-item.dragging { opacity: 0.5; border-color: var(--accent); }
        .platform-drag { color: var(--text-secondary); font-size: 14px; cursor: grab; }
        .platform-checkbox { display: flex; align-items: center; gap: 10px; flex: 1; cursor: pointer; }
        .platform-checkbox input { width: 18px; height: 18px; accent-color: var(--accent); cursor: pointer; }
        .platform-name { font-size: 14px; color: var(--text-primary); }
        .platform-id { font-size: 11px; color: var(--text-secondary); margin-left: auto; }
        /* ÊêúÁ¥¢È°µÈù¢Ê†∑Âºè */
        .search-container { max-width: 900px; margin: 0 auto; }
        .search-box { display: flex; gap: 12px; margin-bottom: 20px; }
        .search-input { flex: 1; padding: 12px 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.15); background: var(--bg-card); color: var(--text-primary); font-size: 15px; }
        .search-input:focus { outline: none; border-color: var(--accent); }
        .search-input::placeholder { color: var(--text-secondary); }
        .search-results { min-height: 200px; }
        .search-hint { text-align: center; padding: 40px; color: var(--text-secondary); font-size: 14px; }
        .search-count { padding: 12px 0; color: var(--text-secondary); font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 12px; }
        .search-list { display: flex; flex-direction: column; gap: 8px; }
        .search-item { display: flex; gap: 12px; padding: 12px 16px; background: var(--bg-card); border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); }
        .search-item:hover { border-color: rgba(255,255,255,0.15); }
        .search-rank { min-width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 12px; color: var(--text-secondary); }
        .search-content { flex: 1; }
        .search-meta { margin-top: 6px; display: flex; gap: 12px; font-size: 12px; color: var(--text-secondary); }
        .search-source { background: rgba(124,58,237,0.15); color: #a78bfa; padding: 2px 8px; border-radius: 4px; }
        mark { background: rgba(250,204,21,0.3); color: #fcd34d; padding: 0 2px; border-radius: 2px; }
        .header-actions { display: flex; align-items: center; gap: 8px; }
        .refresh-btn { width: 36px; height: 36px; border-radius: 8px; border: none; background: rgba(255,255,255,0.1); cursor: pointer; font-size: 16px; transition: all 0.2s; }
        .refresh-btn:hover { background: rgba(255,255,255,0.2); }
        .refresh-btn.loading { animation: spin 1s linear infinite; }
        .crawl-btn { padding: 0; border-radius: 8px; border: none; background: linear-gradient(135deg, #7c3aed, #3b82f6); color: white; cursor: pointer; font-size: 13px; font-weight: 500; transition: opacity 0.2s; width: 100px; height: 36px; white-space: nowrap; display: inline-flex; align-items: center; justify-content: center; }
        .crawl-btn:hover { opacity: 0.9; }
        .crawl-btn.loading { opacity: 0.7; cursor: not-allowed; padding: 0; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .auto-refresh-select { padding: 8px 12px; border-radius: 8px; border: none; background: rgba(255,255,255,0.1); color: var(--text-primary); font-size: 12px; cursor: pointer; }
        .auto-refresh-select option { background: var(--bg-secondary); }
        .actions-dropdown { position: relative; }
        .actions-btn { padding: 8px 16px; border-radius: 8px; border: none; background: linear-gradient(135deg, #7c3aed, #3b82f6); color: white; cursor: pointer; font-size: 13px; font-weight: 500; }
        .actions-btn:hover { opacity: 0.9; }
        .actions-menu { display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); min-width: 180px; z-index: 1000; padding: 8px 0; }
        .actions-menu.show { display: block; }
        .actions-menu button { display: block; width: 100%; padding: 10px 16px; border: none; background: transparent; color: var(--text-primary); font-size: 13px; text-align: left; cursor: pointer; }
        .actions-menu button:hover { background: rgba(255,255,255,0.1); }
        .menu-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 8px 0; }
        .menu-checkbox { display: flex; align-items: center; gap: 8px; padding: 10px 16px; font-size: 13px; color: var(--text-primary); cursor: pointer; }
        .menu-checkbox:hover { background: rgba(255,255,255,0.1); }
        .menu-checkbox input { width: 16px; height: 16px; accent-color: var(--accent); }
        .menu-label { padding: 6px 16px; font-size: 11px; color: var(--text-secondary); text-transform: uppercase; }
        .menu-select { width: calc(100% - 32px); margin: 0 16px 8px; padding: 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15); background: var(--bg-secondary); color: var(--text-primary); font-size: 12px; }
        .menu-select option { background: var(--bg-secondary); }
        .update-time-header { font-size: 12px; color: var(--text-secondary); padding: 6px 12px; background: rgba(255,255,255,0.05); border-radius: 6px; }
        @media (max-width: 768px) { .header-content { flex-direction: column; } .card-grid, .topics-nav-grid { grid-template-columns: 1fr; } .news-card { height: 360px; } }
        .loading { text-align: center; padding: 40px; color: var(--text-secondary); }
        .new-news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 12px; }
        .new-news-item { display: flex; align-items: flex-start; gap: 10px; padding: 12px 14px; background: var(--bg-card); border-radius: 10px; transition: all 0.2s; }
        .new-news-item:hover { background: rgba(124,58,237,0.15); transform: translateY(-2px); }
        .new-news-item .news-rank { min-width: 24px; height: 24px; flex-shrink: 0; }
        .new-news-item .news-text { flex: 1; min-width: 0; }
        .new-news-item .news-title-link { display: block; font-size: 14px; line-height: 1.4; }
        .new-news-item .news-meta { margin-top: 6px; }
        .topic-tag { display: inline-block; padding: 2px 6px; margin: 0 2px; background: rgba(124,58,237,0.2); color: #a78bfa; border-radius: 4px; font-size: 10px; cursor: pointer; transition: all 0.2s; }
        .topic-tag:hover { background: rgba(124,58,237,0.4); }
        .keywords-popup { position: fixed; z-index: 1000; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); min-width: 280px; max-width: 400px; }
        .keywords-popup-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .keywords-popup-title { font-weight: 600; font-size: 14px; }
        .keywords-popup-close { cursor: pointer; font-size: 20px; color: var(--text-secondary); padding: 0 4px; }
        .keywords-popup-close:hover { color: var(--text-primary); }
        .keywords-popup-content { padding: 12px 16px; display: flex; flex-wrap: wrap; gap: 8px; max-height: 300px; overflow-y: auto; }
        .keyword-item { display: inline-block; padding: 4px 10px; background: rgba(124,58,237,0.15); color: #a78bfa; border-radius: 6px; font-size: 12px; }
        .no-keywords { color: var(--text-secondary); font-size: 13px; }
        .filter-panel { background: var(--bg-card); border-radius: 12px; padding: 12px 16px; margin-bottom: 20px; }
        .filter-header { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .filter-header.sub { margin-top: 10px; }
        .filter-label { font-weight: 600; color: var(--text-primary); font-size: 13px; }
        .filter-toggle { cursor: pointer; font-size: 11px; color: var(--text-secondary); padding: 3px 8px; border-radius: 4px; background: rgba(255,255,255,0.05); }
        .filter-toggle:hover { background: rgba(255,255,255,0.15); color: var(--text-primary); }
        .filter-summary { font-size: 11px; color: var(--text-secondary); flex: 1; }
        .filter-summary span { color: var(--accent); }
        .filter-body { margin-top: 10px; }
        .filter-body.collapsed { display: none; }
        .filter-label { font-weight: 600; color: var(--text-primary); }
        .filter-mode { display: flex; gap: 8px; }
        .mode-btn { padding: 6px 12px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: transparent; color: var(--text-secondary); cursor: pointer; font-size: 12px; transition: all 0.2s; }
        .mode-btn:hover { background: rgba(255,255,255,0.15); color: var(--text-primary); }
        .mode-btn.active { background: var(--accent); border-color: var(--accent); color: white; }
        .clear-btn { padding: 6px 12px; border: 1px solid rgba(239,68,68,0.5); border-radius: 6px; background: transparent; color: #ef4444; cursor: pointer; font-size: 12px; transition: all 0.2s; }
        .clear-btn:hover { background: rgba(239,68,68,0.15); }
        .filter-topics-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .filter-topic-chip { display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px; border: 1px solid rgba(255,255,255,0.15); border-radius: 20px; background: rgba(255,255,255,0.05); font-size: 13px; transition: all 0.2s; }
        .filter-topic-chip:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.25); }
        .filter-topic-chip.has-selection { background: rgba(124,58,237,0.2); border-color: var(--accent); }
        .filter-topic-name { cursor: pointer; color: var(--text-secondary); transition: all 0.2s; }
        .filter-topic-chip:hover .filter-topic-name { color: var(--text-primary); }
        .filter-topic-name.selected { color: white; font-weight: 600; }
        .filter-topic-expand { cursor: pointer; font-size: 10px; color: var(--text-secondary); padding: 2px 4px; border-radius: 4px; margin-left: 2px; }
        .filter-topic-expand:hover { background: rgba(255,255,255,0.15); color: var(--text-primary); }
        .filter-topic-badge { font-size: 10px; background: rgba(124,58,237,0.3); color: #a78bfa; padding: 1px 5px; border-radius: 8px; margin-left: 2px; }
        .kw-popup { position: fixed; z-index: 1000; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); min-width: 200px; max-width: 350px; max-height: 300px; overflow: hidden; }
        .kw-popup-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .kw-popup-title { font-weight: 600; font-size: 13px; }
        .kw-popup-actions { display: flex; gap: 8px; }
        .kw-popup-btn { font-size: 11px; padding: 3px 8px; border-radius: 4px; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: var(--text-secondary); transition: all 0.2s; }
        .kw-popup-btn:hover { background: rgba(255,255,255,0.15); color: var(--text-primary); }
        .kw-popup-btn.active { background: var(--accent); border-color: var(--accent); color: white; }
        .kw-popup-close { cursor: pointer; font-size: 18px; color: var(--text-secondary); padding: 0 4px; }
        .kw-popup-close:hover { color: var(--text-primary); }
        .kw-popup-content { padding: 10px 14px; display: flex; flex-wrap: wrap; gap: 6px; max-height: 220px; overflow-y: auto; }
        .kw-item { padding: 4px 10px; border: 1px solid rgba(255,255,255,0.15); border-radius: 14px; font-size: 12px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
        .kw-item:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.25); color: var(--text-primary); }
        .kw-item.selected { background: rgba(124,58,237,0.3); border-color: var(--accent); color: white; }
        .filter-info { font-size: 12px; color: var(--text-secondary); }
        .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(34,197,94,0.95); color: white; padding: 16px 32px; border-radius: 12px; font-size: 16px; font-weight: 600; z-index: 9999; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: toastIn 0.3s ease; }
        @keyframes toastIn { from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
        @media (max-width: 900px) { .new-news-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
<header class="header">
    <div class="header-content">
        <div class="logo"><div class="logo-icon">üì°</div><span class="logo-text">TrendRadar</span><span class="logo-version">v1.0</span></div>
        <nav class="main-tabs">
            <button class="main-tab active" data-view="topics">‰∏ªÈ¢òËÅöÂêà</button>
            <button class="main-tab" data-view="newonly">Â¢ûÈáèÊñ∞Èóª</button>
            <button class="main-tab" data-view="sources">Êù•Ê∫êËÅöÂêà</button>
            <button class="main-tab" data-view="report">ÂéüÂßãÊä•Âëä</button>
            <button class="main-tab" data-view="nav">‰∏ªÈ¢òÂØºËà™</button>
            <button class="main-tab" data-view="filter">Á≠õÈÄâ</button>
            <button class="main-tab" data-view="search">ÊêúÁ¥¢</button>
            <button class="main-tab" data-view="allnews">ÂÖ®ÈÉ®Êñ∞Èóª</button>
            <button class="main-tab" data-view="settings">ËÆæÁΩÆ</button>
        </nav>
        <div class="header-actions">
            <span class="update-time-header">Êõ¥Êñ∞: <span id="updateTime">Âä†ËΩΩ‰∏≠...</span></span>
            <div class="actions-dropdown">
                <button class="actions-btn" onclick="toggleActionsMenu()">‚öôÔ∏è Êìç‰Ωú ‚ñº</button>
                <div class="actions-menu" id="actionsMenu">
                    <button onclick="triggerCrawl(); closeActionsMenu();">üï∑Ô∏è Á´ãÂç≥Áà¨Âèñ</button>
                    <button onclick="clearServerCache(); closeActionsMenu();">üóëÔ∏è Âà∑Êñ∞ÁºìÂ≠ò</button>
                    <button onclick="refreshData(); closeActionsMenu();">üîÑ Âà∑Êñ∞Êï∞ÊçÆ</button>
                    <div class="menu-divider"></div>
                    <label class="menu-checkbox"><input type="checkbox" id="hideEmptyTopics" checked onchange="saveDisplaySettings(); renderView();">ÈöêËóèÁ©∫‰∏ªÈ¢ò</label>
                    <div class="menu-divider"></div>
                    <div class="menu-label">Ëá™Âä®Âà∑Êñ∞</div>
                    <select id="autoRefresh" class="menu-select" onchange="setupAutoRefresh()">
                        <option value="0">ÊâãÂä®Âà∑Êñ∞</option>
                        <option value="60">1ÂàÜÈíü</option>
                        <option value="300" selected>5ÂàÜÈíü</option>
                        <option value="600">10ÂàÜÈíü</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</header>
<div class="sub-header" id="subHeader"><div class="sub-tabs" id="subTabs"></div></div>
<main class="main">
    <div id="viewContainer"></div>
</main>
<script>
const topicsMeta = [
    { icon: "ü§ñ", theme: "purple", category: "ai" }, { icon: "üá®üá≥", theme: "red", category: "world" },
    { icon: "üåè", theme: "blue", category: "world" }, { icon: "üì±", theme: "red", category: "company" },
    { icon: "üöó", theme: "teal", category: "company" }, { icon: "üöÄ", theme: "indigo", category: "ai" },
    { icon: "üçé", theme: "blue", category: "company" }, { icon: "üéÆ", theme: "green", category: "company" },
    { icon: "üîç", theme: "orange", category: "ai" }, { icon: "ü¶æ", theme: "purple", category: "ai" },
    { icon: "üíª", theme: "teal", category: "ai" }, { icon: "üì¶", theme: "red", category: "company" },
    { icon: "üéµ", theme: "pink", category: "company" }, { icon: "üß†", theme: "orange", category: "ai" },
    { icon: "ü§ñ", theme: "purple", category: "ai" }, { icon: "üöô", theme: "green", category: "company" },
    { icon: "üöÅ", theme: "blue", category: "company" }, { icon: "üé¨", theme: "orange", category: "other" },
    { icon: "ü™ü", theme: "blue", category: "company" }, { icon: "üíæ", theme: "red", category: "company" },
    { icon: "üí¨", theme: "teal", category: "ai" }, { icon: "üî¨", theme: "indigo", category: "ai" },
    { icon: "üíß", theme: "blue", category: "other" }
];
const sourceMeta = {
    // === ÁªºÂêàÊñ∞ÈóªÂ™í‰ΩìÁ±ª (news) ===
    '‰ªäÊó•Â§¥Êù°': { icon: 'Â§¥', theme: 'red', category: 'news' }, 'ÁôæÂ∫¶ÁÉ≠Êêú': { icon: 'Áôæ', theme: 'blue', category: 'news' },
    'ÊæéÊπÉÊñ∞Èóª': { icon: 'Êæé', theme: 'red', category: 'news' }, 'Âá§Âá∞ÁΩë': { icon: 'Âá§', theme: 'red', category: 'news' },
    'ÂèÇËÄÉÊ∂àÊÅØ': { icon: 'ÂèÇ', theme: 'red', category: 'news' }, 'Âç´ÊòüÈÄöËÆØÁ§æ': { icon: 'Âç´', theme: 'blue', category: 'news' },
    'ËÅîÂêàÊó©Êä•': { icon: 'Êó©', theme: 'red', category: 'news' }, 'MKTÊñ∞Èóª': { icon: 'M', theme: 'indigo', category: 'news' },
    'Èù†Ë∞±Êñ∞Èóª': { icon: 'Èù†', theme: 'gray', category: 'news' }, 'ËÖæËÆØÊñ∞Èóª': { icon: 'ËÖæ', theme: 'blue', category: 'news' },
    // === Ë¥¢ÁªèÊäïËµÑÁ±ª (finance) ===
    'ÂçéÂ∞îË°óËßÅÈóª': { icon: 'Âçé', theme: 'blue', category: 'finance' }, 'ÂçéÂ∞îË°óËßÅÈóª Âø´ËÆØ': { icon: 'Âçé', theme: 'blue', category: 'finance' },
    'ÂçéÂ∞îË°óËßÅÈóª ÊúÄÁÉ≠': { icon: 'Âçé', theme: 'blue', category: 'finance' }, 'ÂçéÂ∞îË°óËßÅÈóª ÊúÄÊñ∞': { icon: 'Âçé', theme: 'blue', category: 'finance' },
    'Ë¥¢ËÅîÁ§æ': { icon: 'Ë¥¢', theme: 'red', category: 'finance' }, 'Ë¥¢ËÅîÁ§æÁÉ≠Èó®': { icon: 'Ë¥¢', theme: 'red', category: 'finance' },
    'Ë¥¢ËÅîÁ§æ ÁîµÊä•': { icon: 'Ë¥¢', theme: 'red', category: 'finance' }, 'Ë¥¢ËÅîÁ§æ Ê∑±Â∫¶': { icon: 'Ë¥¢', theme: 'red', category: 'finance' },
    'Ê†ºÈöÜÊ±á': { icon: 'Ê†º', theme: 'blue', category: 'finance' }, 'Èõ™ÁêÉ': { icon: 'Èõ™', theme: 'blue', category: 'finance' },
    'ÈáëÂçÅÊï∞ÊçÆ': { icon: 'Èáë', theme: 'blue', category: 'finance' }, 'Âø´ËÆØÈÄö': { icon: 'Âø´', theme: 'emerald', category: 'finance' },
    'Ê≥ïÂ∏ÉË¥¢Áªè Âø´ËÆØ': { icon: 'Ê≥ï', theme: 'emerald', category: 'finance' }, 'Ê≥ïÂ∏ÉË¥¢Áªè Â§¥Êù°': { icon: 'Ê≥ï', theme: 'emerald', category: 'finance' },
    // === Á§æ‰∫§/Áü≠ËßÜÈ¢ëÁ±ª (social) ===
    'ÂæÆÂçö': { icon: 'ÂæÆ', theme: 'red', category: 'social' }, 'ÊäñÈü≥': { icon: 'Êäñ', theme: 'pink', category: 'social' },
    'Âø´Êâã': { icon: 'Âø´', theme: 'orange', category: 'social' }, 'Ë¥¥Âêß': { icon: 'Ë¥¥', theme: 'blue', category: 'social' },
    'Áü•‰πé': { icon: 'Áü•', theme: 'blue', category: 'social' }, 'ËôéÊâë': { icon: 'Ëôé', theme: 'orange', category: 'social' },
    // === ËßÜÈ¢ë/ÂΩ±ËßÜ/Â®±‰πêÁ±ª (video) ===
    'Bilibili': { icon: 'B', theme: 'pink', category: 'video' }, 'ÂìîÂì©ÂìîÂì©': { icon: 'B', theme: 'pink', category: 'video' },
    'bilibili ÁÉ≠Êêú': { icon: 'B', theme: 'pink', category: 'video' }, 'bilibili ÁÉ≠Èó®ËßÜÈ¢ë': { icon: 'B', theme: 'pink', category: 'video' },
    'bilibili ÊéíË°åÊ¶ú': { icon: 'B', theme: 'pink', category: 'video' }, 'ËÖæËÆØËßÜÈ¢ë ÁÉ≠ÊêúÊ¶ú': { icon: 'ËÖæ', theme: 'blue', category: 'video' },
    'Áà±Â•áËâ∫ ÁÉ≠Êí≠Ê¶ú': { icon: 'Ëâ∫', theme: 'green', category: 'video' }, 'Ë±ÜÁì£': { icon: 'Ë±Ü', theme: 'green', category: 'video' },
    // === ÁßëÊäÄÁ±ªÂπ≥Âè∞ (tech) ===
    'IT‰πãÂÆ∂': { icon: 'IT', theme: 'red', category: 'tech' }, '36Ê∞™': { icon: '36', theme: 'blue', category: 'tech' },
    '36Ê∞™ Âø´ËÆØ': { icon: '36', theme: 'blue', category: 'tech' }, '36Ê∞™ ‰∫∫Ê∞îÊ¶ú': { icon: '36', theme: 'blue', category: 'tech' },
    'ÊéòÈáë': { icon: 'Êéò', theme: 'blue', category: 'tech' }, 'GitHub': { icon: 'G', theme: 'purple', category: 'tech' },
    'Hacker News': { icon: 'Y', theme: 'orange', category: 'tech' }, 'Solidot': { icon: 'S', theme: 'green', category: 'tech' },
    'V2EX': { icon: 'V', theme: 'teal', category: 'tech' }, 'ÁâõÂÆ¢ÁΩë': { icon: 'Áâõ', theme: 'blue', category: 'tech' },
    'ËøúÊôØËÆ∫Âùõ': { icon: 'Ëøú', theme: 'blue', category: 'tech' }, 'Â∞ëÊï∞Ê¥æ': { icon: 'Â∞ë', theme: 'red', category: 'tech' },
    'ProductHunt': { icon: 'P', theme: 'orange', category: 'tech' }, 'ÈÖ∑ÂÆâ': { icon: 'ÈÖ∑', theme: 'green', category: 'tech' },
    'Freebuf ÁΩëÁªúÂÆâÂÖ®': { icon: 'F', theme: 'green', category: 'tech' },
    // === Á§æÂå∫/ËÆ∫ÂùõÁ±ª (community) ===
    'Ëô´ÈÉ®ËêΩ': { icon: 'Ëô´', theme: 'green', category: 'community' }, 'Ëô´ÈÉ®ËêΩ ÊúÄÊñ∞': { icon: 'Ëô´', theme: 'green', category: 'community' },
    'Ëô´ÈÉ®ËêΩ ÊúÄÁÉ≠': { icon: 'Ëô´', theme: 'green', category: 'community' },
    // === Ê∏∏ÊàèÁ±ª (game) ===
    'Steam Âú®Á∫ø‰∫∫Êï∞': { icon: 'S', theme: 'blue', category: 'game' }, 'Steam': { icon: 'S', theme: 'blue', category: 'game' }
};
let topicsData = [], sourcesData = [], currentView = 'topics', currentFilter = 'all', autoRefreshTimer = null;

function loadStateFromHash() {
    const hash = decodeURIComponent(window.location.hash.slice(1));
    if (hash) {
        const [view, filter] = hash.split('/');
        if (['topics', 'sources', 'allnews', 'search', 'filter', 'newonly', 'nav', 'report', 'settings'].includes(view)) {
            currentView = view;
            currentFilter = filter || 'all';
        }
    }
}

function saveStateToHash() {
    window.location.hash = currentFilter !== 'all' ? `${currentView}/${currentFilter}` : currentView;
}

// ‰∏ªÈ¢òÁ≠õÈÄâÁä∂ÊÄÅ
let selectedTopics = []; // Ê†ºÂºè: [{topic: '‰∏ªÈ¢òÂêç', keywords: ['ÂÖ≥ÈîÆËØç1', 'ÂÖ≥ÈîÆËØç2']}] Êàñ [{topic: '‰∏ªÈ¢òÂêç', keywords: 'all'}]
let selectedSources = []; // Êù•Ê∫êÁ≠õÈÄâ
let filterMode = 'or'; // 'or' Êàñ 'and'
let expandedTopics = []; // Â±ïÂºÄÁöÑ‰∏ªÈ¢òÂàóË°®
let filterPanelExpanded = true; // Á≠õÈÄâÈù¢ÊùøÂ±ïÂºÄÁä∂ÊÄÅ

// Âä®ÊÄÅÁîüÊàêÁöÑÂàÜÁ±ªÈÖçÁΩÆ
let topicCategories = [];

const subTabsConfig = {
    topics: [{ id: 'all', name: 'ÂÖ®ÈÉ®' }], // ÂàùÂßãÈªòËÆ§ÂÄºÔºåÊï∞ÊçÆÂä†ËΩΩÂêéÂä®ÊÄÅÊõ¥Êñ∞
    sources: [{ id: 'all', name: 'ÂÖ®ÈÉ®' }, { id: 'news', name: 'Êñ∞ÈóªÂ™í‰Ωì' }, { id: 'finance', name: 'Ë¥¢ÁªèÊäïËµÑ' }, { id: 'social', name: 'Á§æ‰∫§Áü≠ËßÜÈ¢ë' }, { id: 'video', name: 'ÂΩ±ËßÜÂ®±‰πê' }, { id: 'tech', name: 'ÁßëÊäÄ' }, { id: 'community', name: 'Á§æÂå∫ËÆ∫Âùõ' }, { id: 'game', name: 'Ê∏∏Êàè' }],
    allnews: [{ id: 'all', name: 'ÂÖ®ÈÉ®' }, { id: 'news', name: 'Êñ∞ÈóªÂ™í‰Ωì' }, { id: 'finance', name: 'Ë¥¢ÁªèÊäïËµÑ' }, { id: 'social', name: 'Á§æ‰∫§Áü≠ËßÜÈ¢ë' }, { id: 'video', name: 'ÂΩ±ËßÜÂ®±‰πê' }, { id: 'tech', name: 'ÁßëÊäÄ' }, { id: 'community', name: 'Á§æÂå∫ËÆ∫Âùõ' }, { id: 'game', name: 'Ê∏∏Êàè' }],
    search: [],
    filter: [],
    newonly: [],
    nav: [{ id: 'all', name: 'ÂÖ®ÈÉ®‰∏ªÈ¢ò' }], report: [], settings: []
};

function updateTopicCategories() {
    // ‰ªé topicsData ‰∏≠ÊèêÂèñÊâÄÊúâÂàÜÁ±ª
    const categories = new Set();
    topicsData.forEach(t => {
        if (t.category) categories.add(t.category);
    });
    topicCategories = Array.from(categories);
    // Êõ¥Êñ∞ subTabsConfig
    subTabsConfig.topics = [{ id: 'all', name: 'ÂÖ®ÈÉ®' }].concat(
        topicCategories.map(c => ({ id: c, name: c }))
    );
    // Ê∑ªÂä†"ÂÖ∂‰ªñ"Â¶ÇÊûúÊúâÊú™ÂàÜÁ±ªÁöÑ
    if (!categories.has('ÂÖ∂‰ªñ') && topicsData.some(t => !t.category || t.category === 'ÂÖ∂‰ªñ')) {
        subTabsConfig.topics.push({ id: 'ÂÖ∂‰ªñ', name: 'ÂÖ∂‰ªñ' });
    }
}

async function loadData() {
    try {
        const [topicsRes, sourcesRes] = await Promise.all([fetch('/api/topics'), fetch('/api/sources')]);
        const topicsJson = await topicsRes.json();
        const sourcesJson = await sourcesRes.json();
        topicsData = topicsJson.topics || [];
        sourcesData = sourcesJson.sources || [];
        document.getElementById('updateTime').textContent = topicsJson.update_time || 'Êú™Áü•';
        updateTopicCategories();
        renderView();
        return true;
    } catch (e) {
        console.error('API load failed, fallback to HTML parsing', e);
        return loadDataFromHTML();
    }
}

async function loadDataFromHTML() {
    try {
        const res = await fetch('index.html');
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const dateEl = doc.querySelector('.info-value');
        if (dateEl) document.getElementById('updateTime').textContent = dateEl.textContent;
        topicsData = []; sourcesData = [];
        const sourcesMap = {};
        doc.querySelectorAll('.word-group').forEach((group, idx) => {
            const nameEl = group.querySelector('.word-name');
            const countEl = group.querySelector('.word-count');
            const news = [];
            group.querySelectorAll('.news-item').forEach((item, i) => {
                const link = item.querySelector('.news-link');
                const source = item.querySelector('.source-name');
                if (link) {
                    const n = { rank: i + 1, title: link.textContent.trim(), url: link.href, source: source ? source.textContent.trim() : '' };
                    news.push(n);
                    if (n.source) { if (!sourcesMap[n.source]) sourcesMap[n.source] = []; sourcesMap[n.source].push({ title: n.title, url: n.url }); }
                }
            });
            topicsData.push({ id: idx, name: nameEl ? nameEl.textContent.trim() : `Topic ${idx}`, count: countEl ? parseInt(countEl.textContent) : news.length, news });
        });
        sourcesData = Object.entries(sourcesMap).sort((a, b) => b[1].length - a[1].length).map(([name, news]) => ({ name, count: news.length, news }));
        renderView();
        return true;
    } catch (e) { document.getElementById('viewContainer').innerHTML = '<div class="loading">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞</div>'; return false; }
}

function renderSubTabs() {
    const tabs = subTabsConfig[currentView] || [];
    document.getElementById('subHeader').style.display = tabs.length ? 'block' : 'none';
    // Â¶ÇÊûúÂΩìÂâç filter ‰∏çÂú® tabs ‰∏≠ÔºåÈáçÁΩÆ‰∏∫ all
    if (tabs.length && !tabs.find(t => t.id === currentFilter)) {
        currentFilter = 'all';
    }
    document.getElementById('subTabs').innerHTML = tabs.map(t => `<button class="sub-tab ${t.id === currentFilter ? 'active' : ''}" data-filter="${t.id}">${t.name}</button>`).join('');
}

function renderView() {
    renderSubTabs();
    const container = document.getElementById('viewContainer');
    if (currentView === 'topics') renderTopicsView(container);
    else if (currentView === 'sources') renderSourcesView(container);
    else if (currentView === 'allnews') renderAllNewsView(container);
    else if (currentView === 'search') renderSearchView(container);
    else if (currentView === 'filter') renderFilterView(container);
    else if (currentView === 'newonly') renderNewOnlyView(container);
    else if (currentView === 'nav') renderNavView(container);
    else if (currentView === 'report') container.innerHTML = '<iframe src="index.html" class="report-frame"></iframe>';
    else if (currentView === 'settings') renderSettingsView(container);
    // Ê£ÄÊµãÂçïË°åÂ∏ÉÂ±ÄÂπ∂Ë∞ÉÊï¥È´òÂ∫¶
    setTimeout(adjustSingleRowLayout, 50);
}

function adjustSingleRowLayout() {
    const grid = document.querySelector('.card-grid');
    if (!grid) return;
    const cards = grid.querySelectorAll('.news-card');
    if (cards.length === 0) return;
    // Ëé∑ÂèñÁ¨¨‰∏Ä‰∏™Âç°ÁâáÁöÑ‰ΩçÁΩÆ
    const firstCardTop = cards[0].getBoundingClientRect().top;
    // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÂç°ÁâáÈÉΩÂú®Âêå‰∏ÄË°å
    let isSingleRow = true;
    for (let i = 1; i < cards.length; i++) {
        if (Math.abs(cards[i].getBoundingClientRect().top - firstCardTop) > 10) {
            isSingleRow = false;
            break;
        }
    }
    grid.classList.toggle('single-row', isSingleRow);
}

function renderTopicsView(container) {
    let topics = topicsData.map((t, i) => {
        const meta = topicsMeta[i] || { icon: 'üì∞', theme: 'purple' };
        return { ...t, icon: meta.icon, theme: meta.theme }; // ‰∏çË¶ÜÁõñ category
    });
    if (currentFilter !== 'all') topics = topics.filter(t => t.category === currentFilter);
    // ÈöêËóèÁ©∫‰∏ªÈ¢ò
    const hideEmpty = document.getElementById('hideEmptyTopics')?.checked ?? true;
    if (hideEmpty) topics = topics.filter(t => t.count > 0);
    container.innerHTML = `<div class="card-grid">${topics.map((t, idx) => `
        <div class="news-card theme-${t.theme}"><div class="card-header"><div class="card-title-wrap"><div class="card-icon" onclick="showKeywordsPopup(${idx}, event)" style="cursor:pointer" title="ÁÇπÂáªÊü•ÁúãÂÖ≥ÈîÆËØç">${t.icon}</div><div><div class="card-title">${t.name}</div><div class="card-subtitle">${t.count} Êù°Êñ∞Èóª</div></div></div><span class="card-count">${t.count}</span></div>
        <div class="news-list">${(t.news || []).map((n, i) => `<div class="news-item"><span class="news-rank ${i < 3 ? 'top-' + (i+1) : ''}">${n.rank}</span><div class="news-text"><a href="${n.url}" target="_blank" class="news-title-link">${n.title}${n.isNew ? ' <span class="news-new">NEW</span>' : ''}</a><div class="news-meta"><span class="news-source" onclick="jumpToSourceFilter('${n.source}')">${n.source}</span>${formatSubTags(n.matchedTopics, t.name)}</div></div></div>`).join('')}</div></div>`).join('')}</div>`;
}

function formatSubTags(matchedTopics, parentTopic) {
    if (!matchedTopics || matchedTopics.length === 0) return '';
    const tags = [];
    matchedTopics.forEach(mt => {
        if (mt.topic === parentTopic) {
            // Âêå‰∏Ä‰∏ªÈ¢òÔºåÂè™ÊòæÁ§∫ÂåπÈÖçÁöÑÂÖ≥ÈîÆËØçÔºåÁÇπÂáªË∑≥ËΩ¨Âà∞ËØ•‰∏ªÈ¢ò+ÂÖ≥ÈîÆËØç
            mt.matched.forEach(m => tags.push({ text: m, topic: mt.topic, kw: m }));
        } else {
            // ‰∏çÂêå‰∏ªÈ¢òÔºåÊòæÁ§∫ ‰∏ªÈ¢ò:ÂÖ≥ÈîÆËØç
            tags.push({ text: `${mt.topic}:${mt.matched.join(' ')}`, topic: mt.topic, kw: mt.matched.join(',') });
        }
    });
    if (tags.length === 0) return '';
    return ' ' + tags.map(t => `<span class="topic-tag" onclick="jumpToFilter('${t.topic}', '${t.kw.replace(/'/g, "\\'")}')">${t.text}</span>`).join(' ');
}

function showKeywordsPopup(topicIdx, event) {
    event.stopPropagation();
    const topic = topicsData[topicIdx];
    if (!topic) return;
    
    // ÁßªÈô§Â∑≤ÊúâÂºπÁ™ó
    const existing = document.querySelector('.keywords-popup');
    if (existing) existing.remove();
    
    const keywords = topic.keywords || [];
    const popup = document.createElement('div');
    popup.className = 'keywords-popup';
    popup.innerHTML = `
        <div class="keywords-popup-header">
            <span class="keywords-popup-title">${topic.name} ÂÖ≥ÈîÆËØç</span>
            <span class="keywords-popup-close" onclick="this.parentElement.parentElement.remove()">√ó</span>
        </div>
        <div class="keywords-popup-content">
            ${keywords.length > 0 ? keywords.map(k => `<span class="keyword-item">${k}</span>`).join('') : '<span class="no-keywords">ÊöÇÊó†ÂÖ≥ÈîÆËØç</span>'}
        </div>
    `;
    document.body.appendChild(popup);
    
    // ÂÆö‰ΩçÂºπÁ™ó
    const rect = event.target.getBoundingClientRect();
    popup.style.top = (rect.bottom + 10) + 'px';
    popup.style.left = Math.max(10, rect.left - 100) + 'px';
    
    // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠
    setTimeout(() => {
        document.addEventListener('click', function closePopup(e) {
            if (!popup.contains(e.target)) {
                popup.remove();
                document.removeEventListener('click', closePopup);
            }
        });
    }, 100);
}

function renderSourcesView(container) {
    let sources = sourcesData.map(s => ({ ...s, ...(sourceMeta[s.name] || { icon: s.name[0], theme: 'purple', category: 'news' }) }));
    if (currentFilter !== 'all') sources = sources.filter(s => s.category === currentFilter);
    container.innerHTML = `<div class="card-grid">${sources.map(s => `
        <div class="news-card theme-${s.theme}"><div class="card-header"><div class="card-title-wrap"><div class="card-icon">${s.icon}</div><div><div class="card-title" onclick="jumpToSourceFilter('${s.name}')" style="cursor:pointer">${s.name}</div><div class="card-subtitle">${s.category}</div></div></div><span class="card-count">${s.count}</span></div>
        <div class="news-list">${(s.news || []).map((n, i) => `<div class="news-item"><span class="news-rank ${i < 3 ? 'top-' + (i+1) : ''}">${i + 1}</span><div class="news-text"><a href="${n.url}" target="_blank" class="news-title-link">${n.title}${n.isNew ? ' <span class="news-new">NEW</span>' : ''}</a><div class="news-meta">${formatMatchedTopics(n.matchedTopics)}</div></div></div>`).join('')}</div></div>`).join('')}</div>`;
}

// ÂÖ®ÈÉ®Êñ∞ÈóªÊï∞ÊçÆÁºìÂ≠ò
let allNewsData = { sources: [], total: 0, loaded: false };

async function renderAllNewsView(container) {
    container.innerHTML = '<div class="loading">Âä†ËΩΩÂÖ®ÈÉ®Êñ∞Èóª...</div>';
    
    if (!allNewsData.loaded) {
        try {
            const res = await fetch('/api/allnews');
            const data = await res.json();
            if (data.success) {
                allNewsData.sources = data.sources;
                allNewsData.total = data.total;
                allNewsData.loaded = true;
            } else {
                container.innerHTML = `<div class="loading">Âä†ËΩΩÂ§±Ë¥•: ${data.error}</div>`;
                return;
            }
        } catch (e) {
            container.innerHTML = `<div class="loading">Âä†ËΩΩÂ§±Ë¥•: ${e.message}</div>`;
            return;
        }
    }
    
    let sources = allNewsData.sources.map(s => ({ ...s, ...(sourceMeta[s.name] || { icon: s.name[0], theme: 'purple', category: 'news' }) }));
    if (currentFilter !== 'all') sources = sources.filter(s => s.category === currentFilter);
    
    container.innerHTML = `<div class="update-info">ÂÖ± ${allNewsData.total} Êù°Êñ∞ÈóªÔºå${allNewsData.sources.length} ‰∏™Êù•Ê∫êÔºàÊï∞ÊçÆÊù•Ëá™Êï∞ÊçÆÂ∫ìÔºåÊú™ÁªèÂÖ≥ÈîÆËØçËøáÊª§Ôºâ</div>
    <div class="card-grid">${sources.map(s => `
        <div class="news-card theme-${s.theme}"><div class="card-header"><div class="card-title-wrap"><div class="card-icon">${s.icon}</div><div><div class="card-title">${s.name}</div><div class="card-subtitle">${s.count} Êù°</div></div></div><span class="card-count">${s.count}</span></div>
        <div class="news-list">${(s.news || []).map((n, i) => `<div class="news-item"><span class="news-rank ${n.rank <= 3 ? 'top-' + n.rank : ''}">${n.rank}</span><div class="news-text"><a href="${n.url}" target="_blank" class="news-title-link">${n.title}</a></div></div>`).join('')}</div></div>`).join('')}</div>`;
}

// ÊêúÁ¥¢Áõ∏ÂÖ≥
let searchResults = { keyword: '', results: [], count: 0 };

function renderSearchView(container) {
    container.innerHTML = `<div class="search-container">
        <div class="search-box">
            <input type="text" id="searchInput" class="search-input" placeholder="ËæìÂÖ•ÂÖ≥ÈîÆËØçÊêúÁ¥¢ÂÖ®ÈÉ®Êñ∞Èóª..." value="${searchResults.keyword}" onkeypress="if(event.key==='Enter')doSearch()">
            <button class="btn-primary" onclick="doSearch()">ÊêúÁ¥¢</button>
        </div>
        <div id="searchResults" class="search-results">
            ${searchResults.results.length > 0 ? renderSearchResults() : '<div class="search-hint">ËæìÂÖ•ÂÖ≥ÈîÆËØçÂêéÁÇπÂáªÊêúÁ¥¢ÔºåÂ∞ÜÂú®‰ªäÊó•ÂÖ®ÈÉ®Êñ∞Èóª‰∏≠Êü•Êâæ</div>'}
        </div>
    </div>`;
}

function renderSearchResults() {
    if (searchResults.results.length === 0) {
        return `<div class="search-hint">Êú™ÊâæÂà∞ÂåÖÂê´ "${searchResults.keyword}" ÁöÑÊñ∞Èóª</div>`;
    }
    return `<div class="search-count">ÊâæÂà∞ ${searchResults.count} Êù°ÂåÖÂê´ "${searchResults.keyword}" ÁöÑÊñ∞Èóª</div>
    <div class="search-list">${searchResults.results.map((n, i) => `
        <div class="search-item">
            <span class="search-rank">${i + 1}</span>
            <div class="search-content">
                <a href="${n.url}" target="_blank" class="news-title-link">${highlightKeyword(n.title, searchResults.keyword)}</a>
                <div class="search-meta"><span class="search-source">${n.source}</span><span class="search-original-rank">ÂéüÊéíÂêç: ${n.rank}</span></div>
            </div>
        </div>
    `).join('')}</div>`;
}

function highlightKeyword(text, keyword) {
    if (!keyword) return text;
    const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
}

async function doSearch() {
    const input = document.getElementById('searchInput');
    const keyword = input.value.trim();
    if (!keyword) { alert('ËØ∑ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆËØç'); return; }
    
    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.innerHTML = '<div class="loading">ÊêúÁ¥¢‰∏≠...</div>';
    
    try {
        const res = await fetch('/api/search?q=' + encodeURIComponent(keyword));
        const data = await res.json();
        if (data.success) {
            searchResults = { keyword: data.keyword, results: data.results, count: data.count };
            resultsDiv.innerHTML = renderSearchResults();
        } else {
            resultsDiv.innerHTML = `<div class="search-hint">ÊêúÁ¥¢Â§±Ë¥•: ${data.error}</div>`;
        }
    } catch (e) {
        resultsDiv.innerHTML = `<div class="search-hint">ÊêúÁ¥¢Â§±Ë¥•: ${e.message}</div>`;
    }
}

function formatMatchedTopics(matchedTopics) {
    if (!matchedTopics || matchedTopics.length === 0) return '';
    return matchedTopics.map(mt => `<span class="topic-tag" onclick="jumpToFilter('${mt.topic}', '${(mt.matched || []).join(',').replace(/'/g, "\\'")}')">${mt.topic}:${mt.matched.join(' ')}</span>`).join(' ');
}

function jumpToFilter(topicName, matchedStr) {
    const keywords = matchedStr ? matchedStr.split(',').filter(k => k) : [];
    selectedTopics = [{ topic: topicName, keywords: keywords.length > 0 ? keywords : 'all' }];
    currentView = 'filter';
    currentFilter = 'all';
    updateMainTabs();
    renderView();
    saveStateToHash();
}

function renderNewOnlyView(container) {
    // ‰ªé sources Êï∞ÊçÆ‰∏≠Êî∂ÈõÜÊâÄÊúâÂ∏¶ isNew Ê†áËÆ∞ÁöÑÊñ∞ÈóªÔºàÂåÖÂê´ matchedTopicsÔºâ
    const newNews = [];
    sourcesData.forEach(source => {
        (source.news || []).forEach(n => {
            if (n.isNew) {
                newNews.push({ ...n, sourceName: source.name });
            }
        });
    });
    
    if (newNews.length === 0) {
        container.innerHTML = '<div class="loading">ÊöÇÊó†Â¢ûÈáèÊñ∞Èóª</div>';
        return;
    }
    
    container.innerHTML = `<div class="new-news-grid">${newNews.map((n, i) => `<div class="new-news-item"><span class="news-rank top-1">${i + 1}</span><div class="news-text"><a href="${n.url}" target="_blank" class="news-title-link">${n.title}</a><div class="news-meta"><span class="news-source" onclick="jumpToSourceFilter('${n.sourceName}')">${n.sourceName}</span> ${formatMatchedTopics(n.matchedTopics)}</div></div></div>`).join('')}</div>`;
}

function renderFilterView(container) {
    const topics = topicsData.map((t, i) => ({ ...t, ...(topicsMeta[i] || { icon: 'üì∞', theme: 'purple' }) }));
    const sources = sourcesData.map(s => ({ name: s.name, ...(sourceMeta[s.name] || { icon: s.name[0], theme: 'gray' }) }));
    
    // Êî∂ÈõÜÊâÄÊúâÊñ∞Èóª
    const allNewsMap = new Map();
    sourcesData.forEach(source => {
        (source.news || []).forEach(n => {
            if (!allNewsMap.has(n.title)) {
                allNewsMap.set(n.title, { ...n, sourceName: source.name });
            }
        });
    });
    
    // Á≠õÈÄâÈÄªËæë
    let filteredNews = [];
    const hasTopicFilter = selectedTopics.length > 0;
    const hasSourceFilter = selectedSources.length > 0;
    
    // Âè™ÈÄâ‰∏Ä‰∏™‰∏ªÈ¢ò‰∏îÂÖ®ÈÄâÊó∂ÔºåÁõ¥Êé•‰ΩøÁî®ËØ•‰∏ªÈ¢òÁöÑÊñ∞ÈóªÔºà‰øùÊåÅÂéüÊéíÂ∫èÔºâ
    if (selectedTopics.length === 1 && selectedTopics[0].keywords === 'all' && !hasSourceFilter) {
        const topicData = topicsData.find(t => t.name === selectedTopics[0].topic);
        if (topicData && topicData.news) {
            filteredNews = topicData.news.map(n => ({ ...n, sourceName: n.source }));
        }
    } else if (!hasTopicFilter && !hasSourceFilter) {
        filteredNews = Array.from(allNewsMap.values());
    } else {
        allNewsMap.forEach(news => {
            let topicMatch = true, sourceMatch = true;
            
            // ‰∏ªÈ¢òÁ≠õÈÄâ
            if (hasTopicFilter) {
                const newsMatches = news.matchedTopics || [];
                const matchResults = selectedTopics.map(sel => {
                    const tm = newsMatches.find(mt => mt.topic === sel.topic);
                    if (!tm) return false;
                    if (sel.keywords === 'all') return true;
                    return sel.keywords.some(kw => tm.matched === kw || (Array.isArray(tm.matched) && tm.matched.includes(kw)));
                });
                topicMatch = filterMode === 'or' ? matchResults.some(r => r) : matchResults.every(r => r);
            }
            
            // Êù•Ê∫êÁ≠õÈÄâ
            if (hasSourceFilter) {
                sourceMatch = selectedSources.includes(news.sourceName);
            }
            
            // ÁªÑÂêàÁ≠õÈÄâ
            if (hasTopicFilter && hasSourceFilter) {
                if (topicMatch && sourceMatch) filteredNews.push(news);
            } else if (hasTopicFilter) {
                if (topicMatch) filteredNews.push(news);
            } else {
                if (sourceMatch) filteredNews.push(news);
            }
        });
        // Êåâ rank ÊéíÂ∫èÔºàÁÉ≠Â∫¶‰ªéÈ´òÂà∞‰ΩéÔºâ
        filteredNews.sort((a, b) => (a.rank || 999) - (b.rank || 999));
    }
    
    const topicCount = selectedTopics.reduce((sum, t) => sum + (t.keywords === 'all' ? 1 : t.keywords.length), 0);
    const totalSelected = topicCount + selectedSources.length;
    
    // ÁîüÊàêÁ≠õÈÄâÊù°‰ª∂ÊëòË¶Å
    const topicSummary = selectedTopics.map(t => t.topic).join('„ÄÅ') || 'Êó†';
    const sourceSummary = selectedSources.join('„ÄÅ') || 'Êó†';
    
    container.innerHTML = `
        <div class="filter-panel">
            <div class="filter-header">
                <span class="filter-toggle" onclick="toggleFilterPanel()">${filterPanelExpanded ? '‚ñº Êî∂Ëµ∑' : '‚ñ∂ Â±ïÂºÄ'}</span>
                <div class="filter-mode">
                    <button class="mode-btn ${filterMode === 'or' ? 'active' : ''}" onclick="setFilterMode('or')">Êàñ</button>
                    <button class="mode-btn ${filterMode === 'and' ? 'active' : ''}" onclick="setFilterMode('and')">‰∏é</button>
                </div>
                <button class="clear-btn" onclick="clearAllFilter()">Ê∏ÖÈô§</button>
                <span class="filter-info">${filteredNews.length} Êù°ÁªìÊûú</span>
                ${!filterPanelExpanded ? `<div class="filter-summary">‰∏ªÈ¢ò: <span>${topicSummary}</span> | Êù•Ê∫ê: <span>${sourceSummary}</span></div>` : ''}
            </div>
            <div class="filter-body ${filterPanelExpanded ? '' : 'collapsed'}">
                <div class="filter-header sub"><span class="filter-label">‰∏ªÈ¢òÔºö</span></div>
                <div class="filter-topics-row">
                    ${topics.map(t => {
                        const sel = selectedTopics.find(s => s.topic === t.name);
                        const isAllSelected = sel && sel.keywords === 'all';
                        const selectedKws = sel && sel.keywords !== 'all' ? sel.keywords : [];
                        const hasSelection = !!sel;
                        const badgeText = isAllSelected ? 'ÂÖ®' : (selectedKws.length > 0 ? selectedKws.length : '');
                        return `<span class="filter-topic-chip ${hasSelection ? 'has-selection' : ''}">
                            <span class="filter-topic-name ${isAllSelected ? 'selected' : ''}" onclick="toggleTopicAll('${t.name}')">${t.icon} ${t.name}</span>
                            ${badgeText ? `<span class="filter-topic-badge">${badgeText}</span>` : ''}
                            <span class="filter-topic-expand" onclick="showKwPopup(event, '${t.name}')">‚ñº</span>
                        </span>`;
                    }).join('')}
                </div>
                <div class="filter-header sub"><span class="filter-label">Êù•Ê∫êÔºö</span></div>
                <div class="filter-topics-row">
                    ${sources.map(s => `<span class="filter-topic-chip ${selectedSources.includes(s.name) ? 'has-selection' : ''}" onclick="toggleSourceFilter('${s.name}')">
                        <span class="filter-topic-name ${selectedSources.includes(s.name) ? 'selected' : ''}">${s.name}</span>
                    </span>`).join('')}
                </div>
            </div>
        </div>
        <div class="new-news-grid">${filteredNews.map((n, i) => `<div class="new-news-item"><span class="news-rank">${i + 1}</span><div class="news-text"><a href="${n.url}" target="_blank" class="news-title-link">${n.title}${n.isNew ? ' <span class="news-new">NEW</span>' : ''}</a><div class="news-meta"><span class="news-source" onclick="jumpToSourceFilter('${n.sourceName}')">${n.sourceName}</span> ${formatMatchedTopics(n.matchedTopics)}</div></div></div>`).join('')}</div>
    `;
}

function showKwPopup(event, topicName) {
    event.stopPropagation();
    document.querySelectorAll('.kw-popup').forEach(p => p.remove());
    
    const topic = topicsData.find(t => t.name === topicName);
    const keywords = topic?.keywords || [];
    const sel = selectedTopics.find(s => s.topic === topicName);
    const isAllSelected = sel && sel.keywords === 'all';
    const selectedKws = sel && sel.keywords !== 'all' ? sel.keywords : [];
    
    const popup = document.createElement('div');
    popup.className = 'kw-popup';
    popup.innerHTML = `
        <div class="kw-popup-header">
            <span class="kw-popup-title">${topicName}</span>
            <div class="kw-popup-actions">
                <button class="kw-popup-btn ${isAllSelected ? 'active' : ''}" onclick="selectAllKw('${topicName}')">ÂÖ®ÈÄâ</button>
                <button class="kw-popup-btn" onclick="clearTopicKw('${topicName}')">Ê∏ÖÈô§</button>
            </div>
            <span class="kw-popup-close" onclick="closeKwPopup()">√ó</span>
        </div>
        <div class="kw-popup-content">
            ${keywords.map(kw => `<span class="kw-item ${isAllSelected || selectedKws.includes(kw) ? 'selected' : ''}" onclick="toggleKeyword('${topicName}', '${kw.replace(/'/g, "\\'")}')">${kw}</span>`).join('')}
        </div>
    `;
    
    document.body.appendChild(popup);
    const rect = event.target.getBoundingClientRect();
    popup.style.left = Math.min(rect.left, window.innerWidth - popup.offsetWidth - 10) + 'px';
    popup.style.top = (rect.bottom + 5) + 'px';
    
    setTimeout(() => document.addEventListener('click', closeKwPopup, { once: true }), 10);
}

function closeKwPopup() {
    document.querySelectorAll('.kw-popup').forEach(p => p.remove());
}

function selectAllKw(topicName) {
    const idx = selectedTopics.findIndex(t => t.topic === topicName);
    if (idx >= 0) selectedTopics[idx].keywords = 'all';
    else selectedTopics.push({ topic: topicName, keywords: 'all' });
    renderView();
}

function clearTopicKw(topicName) {
    selectedTopics = selectedTopics.filter(t => t.topic !== topicName);
    renderView();
}

function toggleTopicAll(topicName) {
    const idx = selectedTopics.findIndex(t => t.topic === topicName);
    if (idx >= 0 && selectedTopics[idx].keywords === 'all') {
        selectedTopics.splice(idx, 1);
    } else if (idx >= 0) {
        selectedTopics[idx].keywords = 'all';
    } else {
        selectedTopics.push({ topic: topicName, keywords: 'all' });
    }
    renderView();
}

function toggleKeyword(topicName, keyword) {
    let sel = selectedTopics.find(t => t.topic === topicName);
    if (!sel) {
        selectedTopics.push({ topic: topicName, keywords: [keyword] });
    } else if (sel.keywords === 'all') {
        const topic = topicsData.find(t => t.name === topicName);
        sel.keywords = (topic?.keywords || []).filter(k => k !== keyword);
        if (sel.keywords.length === 0) {
            selectedTopics = selectedTopics.filter(t => t.topic !== topicName);
        }
    } else {
        const kwIdx = sel.keywords.indexOf(keyword);
        if (kwIdx >= 0) {
            sel.keywords.splice(kwIdx, 1);
            if (sel.keywords.length === 0) {
                selectedTopics = selectedTopics.filter(t => t.topic !== topicName);
            }
        } else {
            sel.keywords.push(keyword);
        }
    }
    renderView();
}

function toggleTopicFilter(topicName) {
    toggleTopicAll(topicName);
}

function setFilterMode(mode) {
    filterMode = mode;
    renderView();
}

function clearTopicFilter() {
    selectedTopics = [];
    renderView();
}

function toggleSourceFilter(sourceName) {
    const idx = selectedSources.indexOf(sourceName);
    if (idx >= 0) selectedSources.splice(idx, 1);
    else selectedSources.push(sourceName);
    renderView();
}

function clearAllFilter() {
    selectedTopics = [];
    selectedSources = [];
    renderView();
}

function toggleFilterPanel() {
    filterPanelExpanded = !filterPanelExpanded;
    renderView();
}

function jumpToSourceFilter(sourceName) {
    selectedSources = [sourceName];
    selectedTopics = [];
    currentView = 'filter';
    currentFilter = 'all';
    updateMainTabs();
    renderView();
    saveStateToHash();
}

function renderNavView(container) {
    let topics = topicsData.map((t, i) => ({ ...t, ...(topicsMeta[i] || { icon: 'üì∞', theme: 'purple', category: 'other' }) }));
    // ÈöêËóèÁ©∫‰∏ªÈ¢ò
    const hideEmpty = document.getElementById('hideEmptyTopics')?.checked ?? true;
    if (hideEmpty) topics = topics.filter(t => t.count > 0);
    container.innerHTML = `<div class="topics-nav-grid">${topics.map((t, i) => `
        <div class="topic-nav-card" onclick="switchToTopic(${i})"><div class="topic-nav-header"><div class="topic-nav-icon card-icon theme-${t.theme}" style="background:linear-gradient(135deg,var(--accent),#3b82f6)">${t.icon}</div><div><div class="topic-nav-title">${t.name}</div><div class="topic-nav-keywords">${t.count} Êù°Êñ∞Èóª</div></div></div><div class="topic-nav-stats"><span>${t.category}</span><span class="topic-nav-btn">Êü•ÁúãËØ¶ÊÉÖ ‚Üí</span></div></div>`).join('')}</div>`;
}

// ËÆæÁΩÆÈ°µÈù¢Áõ∏ÂÖ≥ÂèòÈáè
let settingsData = { frequencyWords: '', platforms: [], tabs: [] };

// ÈªòËÆ§Ê®°ÂùóÈÖçÁΩÆ
const defaultTabs = [
    { id: 'topics', name: '‰∏ªÈ¢òËÅöÂêà', enabled: true },
    { id: 'newonly', name: 'Â¢ûÈáèÊñ∞Èóª', enabled: true },
    { id: 'sources', name: 'Êù•Ê∫êËÅöÂêà', enabled: true },
    { id: 'report', name: 'ÂéüÂßãÊä•Âëä', enabled: true },
    { id: 'nav', name: '‰∏ªÈ¢òÂØºËà™', enabled: true },
    { id: 'filter', name: 'Á≠õÈÄâ', enabled: true },
    { id: 'search', name: 'ÊêúÁ¥¢', enabled: true },
    { id: 'allnews', name: 'ÂÖ®ÈÉ®Êñ∞Èóª', enabled: true },
    { id: 'settings', name: 'ËÆæÁΩÆ', enabled: true }
];

async function renderSettingsView(container) {
    container.innerHTML = `<div class="settings-container">
        <div class="settings-tabs">
            <button class="settings-tab active" data-tab="platforms">Êù•Ê∫êÊéíÂ∫è</button>
            <button class="settings-tab" data-tab="topicsorder">‰∏ªÈ¢òÊéíÂ∫è</button>
            <button class="settings-tab" data-tab="topics">‰∏ªÈ¢òÂÖ≥ÈîÆËØç</button>
            <button class="settings-tab" data-tab="tabs">Ê®°ÂùóÊéíÂ∫è</button>
        </div>
        <div class="settings-content">
            <div id="settingsPlatforms" class="settings-panel active">
                <div class="settings-header">
                    <h3>Êù•Ê∫êÊéíÂ∫è</h3>
                    <div class="settings-actions">
                        <button class="btn-secondary" onclick="loadPlatforms()">Âà∑Êñ∞</button>
                        <button class="btn-primary" onclick="savePlatforms()">‰øùÂ≠ò</button>
                    </div>
                </div>
                <div class="settings-help">
                    <p>ÂãæÈÄâÂêØÁî®ÁöÑÊñ∞ÈóªÊù•Ê∫êÔºåÂèñÊ∂àÂãæÈÄâÂèØ‰∏¥Êó∂Á¶ÅÁî®„ÄÇÊãñÊãΩÂèØË∞ÉÊï¥È°∫Â∫è„ÄÇ</p>
                </div>
                <div id="platformsList" class="platforms-list">Âä†ËΩΩ‰∏≠...</div>
            </div>
            <div id="settingsTopicsorder" class="settings-panel">
                <div class="settings-header">
                    <h3>‰∏ªÈ¢òÊéíÂ∫è</h3>
                    <div class="settings-actions">
                        <button class="btn-secondary" onclick="loadTopicsOrder()">Âà∑Êñ∞</button>
                        <button class="btn-primary" onclick="saveTopicsOrder()">‰øùÂ≠ò</button>
                    </div>
                </div>
                <div class="settings-help">
                    <p>ÊãñÊãΩË∞ÉÊï¥‰∏ªÈ¢òÂú®"‰∏ªÈ¢òËÅöÂêà"È°µÈù¢ÁöÑÊòæÁ§∫È°∫Â∫è„ÄÇÂèñÊ∂àÂãæÈÄâÂèØÈöêËóè‰∏ªÈ¢ò„ÄÇ</p>
                </div>
                <div id="topicsOrderList" class="platforms-list">Âä†ËΩΩ‰∏≠...</div>
            </div>
            <div id="settingsTopics" class="settings-panel">
                <div class="settings-header">
                    <h3>‰∏ªÈ¢òÂÖ≥ÈîÆËØçÈÖçÁΩÆ</h3>
                    <div class="settings-actions">
                        <button class="btn-secondary" onclick="loadFrequencyWords()">Âà∑Êñ∞</button>
                        <button class="btn-primary" onclick="saveFrequencyWords()">‰øùÂ≠ò</button>
                    </div>
                </div>
                <div class="settings-help">
                    <p><strong>Ê†ºÂºèËØ¥ÊòéÔºö</strong></p>
                    <ul>
                        <li><code>#‰∏ªÈ¢òÂêç @ÂàÜÁ±ªÂêç</code> - ÂÆö‰πâ‰∏ªÈ¢òÂíåÂàÜÁ±ª</li>
                        <li><code>ÂÖ≥ÈîÆËØç1, ÂÖ≥ÈîÆËØç2</code> - ÊôÆÈÄöÂÖ≥ÈîÆËØçÔºàÈÄóÂè∑ÂàÜÈöîÔºâ</li>
                        <li><code>+ÂøÖÈ°ªËØç</code> - ÂøÖÈ°ªÂåÖÂê´ÁöÑËØç</li>
                        <li><code>-ËøáÊª§ËØç</code> - ÊéíÈô§ÂåÖÂê´Ê≠§ËØçÁöÑÊñ∞Èóª</li>
                        <li><code>Á©∫Ë°å</code> - ÂàÜÈöî‰∏çÂêå‰∏ªÈ¢ò</li>
                    </ul>
                </div>
                <textarea id="frequencyWordsEditor" class="settings-editor" placeholder="Âä†ËΩΩ‰∏≠..."></textarea>
            </div>
            <div id="settingsTabs" class="settings-panel">
                <div class="settings-header">
                    <h3>Ê®°ÂùóÊéíÂ∫è</h3>
                    <div class="settings-actions">
                        <button class="btn-secondary" onclick="loadTabs()">Âà∑Êñ∞</button>
                        <button class="btn-primary" onclick="saveTabs()">‰øùÂ≠ò</button>
                    </div>
                </div>
                <div class="settings-help">
                    <p>ÊãñÊãΩË∞ÉÊï¥È°∂ÈÉ®ÂØºËà™Ê®°ÂùóÁöÑÊòæÁ§∫È°∫Â∫è„ÄÇÂèñÊ∂àÂãæÈÄâÂèØÈöêËóèÊ®°Âùó„ÄÇ</p>
                </div>
                <div id="tabsList" class="platforms-list">Âä†ËΩΩ‰∏≠...</div>
            </div>
        </div>
    </div>`;
    
    // ÁªëÂÆöÊ†áÁ≠æÂàáÊç¢
    container.querySelectorAll('.settings-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            container.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
            container.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById('settings' + tab.dataset.tab.charAt(0).toUpperCase() + tab.dataset.tab.slice(1)).classList.add('active');
        });
    });
    
    // Âä†ËΩΩÊï∞ÊçÆ
    loadFrequencyWords();
    loadPlatforms();
    loadTabs();
    loadTopicsOrder();
}

async function loadFrequencyWords() {
    try {
        const res = await fetch('/api/config/frequency_words');
        const data = await res.json();
        if (data.success) {
            settingsData.frequencyWords = data.content;
            document.getElementById('frequencyWordsEditor').value = data.content;
        } else {
            alert('Âä†ËΩΩÂ§±Ë¥•: ' + data.error);
        }
    } catch (e) {
        alert('Âä†ËΩΩÂ§±Ë¥•: ' + e.message);
    }
}

async function saveFrequencyWords() {
    const content = document.getElementById('frequencyWordsEditor').value;
    try {
        const res = await fetch('/api/config/frequency_words', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
        });
        const data = await res.json();
        if (data.success) {
            settingsData.frequencyWords = content;
            showToast('ËÆæÁΩÆÂÆåÊàê');
        } else {
            alert('‰øùÂ≠òÂ§±Ë¥•: ' + data.error);
        }
    } catch (e) {
        alert('‰øùÂ≠òÂ§±Ë¥•: ' + e.message);
    }
}

async function loadPlatforms() {
    try {
        const res = await fetch('/api/config/platforms');
        const data = await res.json();
        if (data.success) {
            settingsData.platforms = data.platforms;
            renderPlatformsList(data.platforms);
        } else {
            alert('Âä†ËΩΩÂ§±Ë¥•: ' + data.error);
        }
    } catch (e) {
        alert('Âä†ËΩΩÂ§±Ë¥•: ' + e.message);
    }
}

function renderPlatformsList(platforms) {
    const container = document.getElementById('platformsList');
    if (!container) return;
    container.innerHTML = platforms.map((p, i) => `
            <div class="platform-item" draggable="true" data-index="${i}">
                <span class="platform-drag">‚ò∞</span>
                <label class="platform-checkbox">
                    <input type="checkbox" ${p.enabled !== false ? 'checked' : ''} data-id="${p.id}">
                    <span class="platform-name">${p.name}</span>
                    <span class="platform-id">${p.id}</span>
                </label>
            </div>
        `).join('');
    
    // ÊãñÊãΩÊéíÂ∫è
    let draggedItem = null;
    container.querySelectorAll('.platform-item').forEach(item => {
        item.addEventListener('dragstart', e => { draggedItem = item; item.classList.add('dragging'); });
        item.addEventListener('dragend', () => { draggedItem.classList.remove('dragging'); draggedItem = null; });
        item.addEventListener('dragover', e => { e.preventDefault(); if (draggedItem && draggedItem !== item) {
            const rect = item.getBoundingClientRect();
            const next = e.clientY - rect.top > rect.height / 2;
            container.insertBefore(draggedItem, next ? item.nextSibling : item);
        }});
    });
}

async function savePlatforms() {
    const container = document.getElementById('platformsList');
    const platforms = [];
    container.querySelectorAll('.platform-item').forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        const id = checkbox.dataset.id;
        const name = item.querySelector('.platform-name').textContent;
        platforms.push({ 
            id, 
            name,
            enabled: checkbox.checked 
        });
    });
    
    try {
        const res = await fetch('/api/config/platforms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ platforms })
        });
        const data = await res.json();
        if (data.success) {
            settingsData.platforms = platforms;
            showToast('ËÆæÁΩÆÂÆåÊàê');
        } else {
            alert('‰øùÂ≠òÂ§±Ë¥•: ' + data.error);
        }
    } catch (e) {
        alert('‰øùÂ≠òÂ§±Ë¥•: ' + e.message);
    }
}

// Ê®°ÂùóÊéíÂ∫èÁõ∏ÂÖ≥ÂáΩÊï∞
async function loadTabs() {
    try {
        const res = await fetch('/api/config/tabs');
        const data = await res.json();
        if (data.success) {
            // ÂêàÂπ∂‰øùÂ≠òÁöÑÈÖçÁΩÆÂíåÈªòËÆ§ÈÖçÁΩÆ
            let tabs = data.tabs || [];
            if (tabs.length === 0) {
                tabs = JSON.parse(JSON.stringify(defaultTabs));
            } else {
                // Á°Æ‰øùÊâÄÊúâÈªòËÆ§Ê®°ÂùóÈÉΩÂ≠òÂú®
                const savedIds = tabs.map(t => t.id);
                defaultTabs.forEach(dt => {
                    if (!savedIds.includes(dt.id)) {
                        tabs.push({ ...dt });
                    }
                });
            }
            settingsData.tabs = tabs;
            renderTabsList(tabs);
            applyTabsOrder(tabs);
        }
    } catch (e) {
        console.error('Âä†ËΩΩÊ®°ÂùóÈÖçÁΩÆÂ§±Ë¥•:', e);
        renderTabsList(defaultTabs);
    }
}

function renderTabsList(tabs) {
    const container = document.getElementById('tabsList');
    container.innerHTML = tabs.map(tab => `
        <div class="platform-item" draggable="true" data-id="${tab.id}">
            <span class="drag-handle">‚ò∞</span>
            <label class="platform-label">
                <input type="checkbox" data-id="${tab.id}" ${tab.enabled !== false ? 'checked' : ''}>
                <span class="platform-name">${tab.name}</span>
            </label>
        </div>
    `).join('');
    
    // ÁªëÂÆöÊãñÊãΩ‰∫ã‰ª∂
    let draggedItem = null;
    container.querySelectorAll('.platform-item').forEach(item => {
        item.addEventListener('dragstart', e => { draggedItem = item; item.classList.add('dragging'); });
        item.addEventListener('dragend', () => { draggedItem.classList.remove('dragging'); draggedItem = null; });
        item.addEventListener('dragover', e => { e.preventDefault(); if (draggedItem && draggedItem !== item) {
            const rect = item.getBoundingClientRect();
            const next = e.clientY - rect.top > rect.height / 2;
            container.insertBefore(draggedItem, next ? item.nextSibling : item);
        }});
    });
}

async function saveTabs() {
    const container = document.getElementById('tabsList');
    const tabs = [];
    container.querySelectorAll('.platform-item').forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        const id = checkbox.dataset.id;
        const name = item.querySelector('.platform-name').textContent;
        tabs.push({ id, name, enabled: checkbox.checked });
    });
    
    try {
        const res = await fetch('/api/config/tabs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tabs })
        });
        const data = await res.json();
        if (data.success) {
            settingsData.tabs = tabs;
            applyTabsOrder(tabs);
            showToast('ËÆæÁΩÆÂÆåÊàê');
        } else {
            alert('‰øùÂ≠òÂ§±Ë¥•: ' + data.error);
        }
    } catch (e) {
        alert('‰øùÂ≠òÂ§±Ë¥•: ' + e.message);
    }
}

function applyTabsOrder(tabs) {
    const nav = document.querySelector('.main-tabs');
    if (!nav) return;
    
    tabs.forEach(tab => {
        const btn = nav.querySelector(`[data-view="${tab.id}"]`);
        if (btn) {
            btn.style.display = tab.enabled !== false ? '' : 'none';
            nav.appendChild(btn); // ÁßªÂä®Âà∞Êú´Â∞æÔºåÊåâÈ°∫Â∫èÊéíÂàó
        }
    });
}

// ‰∏ªÈ¢òÊéíÂ∫èÁõ∏ÂÖ≥ÂáΩÊï∞
let topicsOrderData = [];

async function loadTopicsOrder() {
    try {
        // ÂÖàËé∑ÂèñÂΩìÂâçÊâÄÊúâ‰∏ªÈ¢ò
        const topicsRes = await fetch('/api/topics');
        const topicsData = await topicsRes.json();
        const allTopics = topicsData.topics || [];
        
        // Ëé∑Âèñ‰øùÂ≠òÁöÑÈ°∫Â∫èÈÖçÁΩÆ
        const orderRes = await fetch('/api/config/topics_order');
        const orderData = await orderRes.json();
        const savedOrder = orderData.topics_order || [];
        
        // ÂêàÂπ∂ÔºöÊåâ‰øùÂ≠òÈ°∫Â∫èÊéíÂàóÔºåÊñ∞‰∏ªÈ¢òËøΩÂä†Âà∞Êú´Â∞æ
        let orderedTopics = [];
        const savedIds = savedOrder.map(t => t.id);
        const allIds = allTopics.map(t => t.id);
        
        // ÂÖàÊ∑ªÂä†‰øùÂ≠òÈ°∫Â∫è‰∏≠Â≠òÂú®ÁöÑ‰∏ªÈ¢ò
        savedOrder.forEach(saved => {
            const topic = allTopics.find(t => t.id === saved.id);
            if (topic) {
                orderedTopics.push({
                    id: topic.id,
                    name: topic.name,
                    category: topic.category || 'Êú™ÂàÜÁ±ª',
                    enabled: saved.enabled !== false
                });
            }
        });
        
        // Ê∑ªÂä†Êñ∞‰∏ªÈ¢òÔºà‰∏çÂú®‰øùÂ≠òÈ°∫Â∫è‰∏≠ÁöÑÔºâ
        allTopics.forEach(topic => {
            if (!savedIds.includes(topic.id)) {
                orderedTopics.push({
                    id: topic.id,
                    name: topic.name,
                    category: topic.category || 'Êú™ÂàÜÁ±ª',
                    enabled: true
                });
            }
        });
        
        topicsOrderData = orderedTopics;
        renderTopicsOrderList(orderedTopics);
    } catch (e) {
        console.error('Âä†ËΩΩ‰∏ªÈ¢òÈ°∫Â∫èÂ§±Ë¥•:', e);
        document.getElementById('topicsOrderList').innerHTML = 'Âä†ËΩΩÂ§±Ë¥•: ' + e.message;
    }
}

function renderTopicsOrderList(topics) {
    const container = document.getElementById('topicsOrderList');
    container.innerHTML = topics.map(topic => `
        <div class="platform-item" draggable="true" data-id="${topic.id}">
            <span class="drag-handle">‚ò∞</span>
            <label class="platform-label">
                <input type="checkbox" data-id="${topic.id}" ${topic.enabled !== false ? 'checked' : ''}>
                <span class="platform-name">${topic.name}</span>
                <span class="platform-category" style="color:#888;font-size:12px;margin-left:8px;">${topic.category}</span>
            </label>
        </div>
    `).join('');
    
    // ÁªëÂÆöÊãñÊãΩ‰∫ã‰ª∂
    let draggedItem = null;
    container.querySelectorAll('.platform-item').forEach(item => {
        item.addEventListener('dragstart', e => { draggedItem = item; item.classList.add('dragging'); });
        item.addEventListener('dragend', () => { draggedItem.classList.remove('dragging'); draggedItem = null; });
        item.addEventListener('dragover', e => { e.preventDefault(); if (draggedItem && draggedItem !== item) {
            const rect = item.getBoundingClientRect();
            const next = e.clientY - rect.top > rect.height / 2;
            container.insertBefore(draggedItem, next ? item.nextSibling : item);
        }});
    });
}

async function saveTopicsOrder() {
    const container = document.getElementById('topicsOrderList');
    const topics_order = [];
    container.querySelectorAll('.platform-item').forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        const id = checkbox.dataset.id;
        const name = item.querySelector('.platform-name').textContent;
        topics_order.push({ id, name, enabled: checkbox.checked });
    });
    
    try {
        const res = await fetch('/api/config/topics_order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ topics_order })
        });
        const data = await res.json();
        if (data.success) {
            topicsOrderData = topics_order;
            showToast('ËÆæÁΩÆÂÆåÊàê');
        } else {
            alert('‰øùÂ≠òÂ§±Ë¥•: ' + data.error);
        }
    } catch (e) {
        alert('‰øùÂ≠òÂ§±Ë¥•: ' + e.message);
    }
}

function showToast(message, duration = 1000) {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), duration);
}

function switchToTopic(idx) { 
    const topic = topicsData[idx];
    currentView = 'topics'; 
    currentFilter = topic?.category || 'all'; 
    renderView(); 
    updateMainTabs(); 
    saveStateToHash();
}
function updateMainTabs() { document.querySelectorAll('.main-tab').forEach(t => t.classList.toggle('active', t.dataset.view === currentView)); }
function refreshData() { allNewsData.loaded = false; loadData(); }
function setupAutoRefresh() { const interval = parseInt(document.getElementById('autoRefresh').value) * 1000; if (autoRefreshTimer) clearInterval(autoRefreshTimer); if (interval > 0) autoRefreshTimer = setInterval(refreshData, interval); }

// ‰∏ãÊãâËèúÂçïÊéßÂà∂
function toggleActionsMenu() { document.getElementById('actionsMenu').classList.toggle('show'); }
function closeActionsMenu() { document.getElementById('actionsMenu').classList.remove('show'); }

// ÊòæÁ§∫ËÆæÁΩÆ
function saveDisplaySettings() {
    const hideEmpty = document.getElementById('hideEmptyTopics').checked;
    localStorage.setItem('hideEmptyTopics', hideEmpty);
}
function loadDisplaySettings() {
    const hideEmpty = localStorage.getItem('hideEmptyTopics');
    if (hideEmpty !== null) {
        document.getElementById('hideEmptyTopics').checked = hideEmpty === 'true';
    }
}

async function clearServerCache() {
    try {
        showToast('Ê≠£Âú®Âà∑Êñ∞ÁºìÂ≠ò...');
        const res = await fetch('/api/refresh');
        const data = await res.json();
        if (data.success) {
            showToast('ÁºìÂ≠òÂ∑≤Âà∑Êñ∞ÔºÅ');
            allNewsData.loaded = false;
            await loadData();
        } else {
            alert('Âà∑Êñ∞ÁºìÂ≠òÂ§±Ë¥•: ' + (data.error || 'Êú™Áü•ÈîôËØØ'));
        }
    } catch (e) {
        alert('ËØ∑Ê±ÇÂ§±Ë¥•: ' + e.message);
    }
}

let crawlRunning = false;
async function triggerCrawl() {
    if (crawlRunning) return;
    crawlRunning = true;
    try {
        showToast('Ê≠£Âú®ÂêØÂä®Áà¨Ëô´...');
        const res = await fetch('/api/crawl');
        const data = await res.json();
        if (data.success) {
            showToast('Áà¨Ëô´Â∑≤ÂêØÂä®ÔºåËØ∑Á®çÂÄô...');
            const checkStatus = setInterval(async () => {
                const statusRes = await fetch('/api/crawl_status');
                const status = await statusRes.json();
                if (!status.running) {
                    clearInterval(checkStatus);
                    crawlRunning = false;
                    showToast('Áà¨ÂèñÂÆåÊàêÔºÅ');
                    refreshData();
                }
            }, 3000);
        } else {
            crawlRunning = false;
            alert(data.message || 'ÂêØÂä®Â§±Ë¥•');
        }
    } catch (e) {
        crawlRunning = false;
        alert('ËØ∑Ê±ÇÂ§±Ë¥•: ' + e.message);
    }
}

document.querySelectorAll('.main-tab').forEach(tab => tab.addEventListener('click', () => { currentView = tab.dataset.view; currentFilter = 'all'; saveStateToHash(); renderView(); updateMainTabs(); }));
document.getElementById('subTabs').addEventListener('click', e => { if (e.target.classList.contains('sub-tab')) { currentFilter = e.target.dataset.filter; saveStateToHash(); renderSubTabs(); renderView(); } });
window.addEventListener('hashchange', () => { loadStateFromHash(); renderView(); updateMainTabs(); });
window.addEventListener('resize', () => setTimeout(adjustSingleRowLayout, 100));
// ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠ËèúÂçï
document.addEventListener('click', e => { if (!e.target.closest('.actions-dropdown')) closeActionsMenu(); });

loadStateFromHash(); updateMainTabs(); loadDisplaySettings(); loadData().then(() => { loadStateFromHash(); renderView(); updateMainTabs(); }); setupAutoRefresh();
// È°µÈù¢Âä†ËΩΩÊó∂Â∫îÁî®Ê®°ÂùóÈ°∫Â∫è
fetch('/api/config/tabs').then(r => r.json()).then(data => { if (data.success && data.tabs) applyTabsOrder(data.tabs); }).catch(() => {});
</script>
</body>
</html>
